<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rediger profil</title>
  <link rel="stylesheet" href="/dashboard.css">
  <link rel="stylesheet" href="/profile.css">
</head>
<body>
  <button class="menu-toggle" data-menu-toggle aria-label="√Öbn menu">‚ò∞ Menu</button>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">U</div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="/dashboard">
          <span class="icon">üè†</span>
          <span>Hjem</span>
        </a>
        <a class="nav-item" href="/kalender">
          <span class="icon">üìÖ</span>
          <span>Kalender</span>
        </a>
        <a class="nav-item" href="/chat">
          <span class="icon">üí¨</span>
          <span>Connect</span>
        </a>
        <a class="nav-item" href="/salg">
          <span class="icon">üí≥</span>
          <span>Salg</span>
        </a>
        <a class="nav-item" href="/storefront">
          <span class="icon">üõçÔ∏è</span>
          <span>Storefront</span>
          <span class="chevron">‚Ä∫</span>
        </a>
        <a class="nav-item active" href="/profile">
          <span class="icon">üë§</span>
          <span>Profil</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <a class="nav-item logout" href="/logout">
          <span class="icon">üö™</span>
          <span>Log ud</span>
        </a>
      </div>
    </aside>
    <div class="menu-overlay" data-menu-overlay></div>

    <main class="content">
      <section class="next-event">
        <h2>Opdater dine oplysninger</h2>
        <div class="next-event-card">
          <form id="profile-form">
            <div class="form-row">
              <label>Fornavn</label>
              <input type="text" name="firstname" required />
            </div>
            <div class="form-row">
              <label>Efternavn</label>
              <input type="text" name="lastname" required />
            </div>
            <div class="form-row">
              <label>Email</label>
              <input type="email" name="email" required />
            </div>
            <div class="form-row">
              <label>Telefon</label>
              <input type="text" name="phone" value="+45" pattern="\+45\d{8}" oninput="if(!this.value.startsWith('\+45')) this.value='+45' + this.value.replace(/[^\d]/g,'').replace(/^45/,'');" />
            </div>
            <div class="form-row">
              <label>By</label>
              <input type="text" name="city" />
            </div>
            <div class="form-row">
              <label>Bio</label>
              <textarea name="bio" rows="4" placeholder="Fort√¶l kort om dig selv"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-secondary">Gem √¶ndringer</button>
              <span id="status" class="subtle"></span>
            </div>
          </form>
        </div>
      </section>
    </main>
  </div>

  <script src="/JS/menu.js"></script>
  <script>
    async function fetchProfile() {
      try {
        const res = await fetch('/api/me');
        if (!res.ok) throw new Error('Unauthorized');
        return res.json();
      } catch (err) {
        window.location.href = '/login';
        throw err;
      }
    }

    function setStatus(text, isError = false) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.style.color = isError ? '#c0392b' : '#2e7d32';
    }

    async function initForm() {
      const form = document.getElementById('profile-form');
      const data = await fetchProfile();

      form.firstname.value = data.firstname || '';
      form.lastname.value = data.lastname || '';
      form.email.value = data.email || '';
      form.phone.value = data.phone || '+45';
      form.city.value = data.city || '';
      form.bio.value = data.bio || '';

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setStatus('Gemmer...', false);

        const phoneRaw = (form.phone.value || '').replace(/\\s+/g, '');
        const phone = phoneRaw.startsWith('+45') ? phoneRaw : `+45${phoneRaw.replace(/^\\+?45/, '')}`;

        const body = {
          firstname: form.firstname.value.trim(),
          lastname: form.lastname.value.trim(),
          email: form.email.value.trim(),
          phone,
          city: form.city.value.trim(),
          bio: form.bio.value.trim()
        };

        try {
          const res = await fetch('/profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Kunne ikke gemme');
          }

          const updated = await res.json();
          setStatus('Profil opdateret!');
          form.email.value = updated.email || form.email.value;
        } catch (err) {
          console.error(err);
          setStatus(err.message || 'Der skete en fejl', true);
        }
      });
    }

    initForm();
  </script>
</body>
</html>
